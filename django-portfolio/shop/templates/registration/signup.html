{% extends "shop/base.html" %}
{% load socialaccount static i18n %}

{% block title %}Signup - My Shoppings{% endblock %}

{% block content %}
<div class="signup-card">
  <h2>Create an account</h2>

  <!-- INLINE OTP ERROR -->
  <div id="otpError" class="error-box" style="display:none;"></div>

  {% if form.non_field_errors %}
    <div class="error-box">{{ form.non_field_errors }}</div>
  {% endif %}

  <!-- GOOGLE -->
  <a href="{% provider_login_url 'google' process='signup' %}" class="google-btn">
    <img src="{% static 'images/google-logo.png' %}" alt="Google">
    Sign up with Google
  </a>

  <div class="or-text">Or</div>

  <form method="post" id="signupForm" novalidate>
    {% csrf_token %}

    {% if show_otp %}
      <!-- READ-ONLY DETAILS -->
      <div class="readonly-block">
        <div><strong>Username:</strong> {{ form.username.value }}</div>
        <div><strong>Email:</strong> {{ form.email.value }}</div>
        <div><strong>Mobile:</strong> {{ form.phone.value }}</div>
      </div>

      <!-- OTP -->
      <div class="otp-box">
        <p>An OTP has been sent to <strong>{{ otp_sent_to }}</strong></p>

        <label>OTP</label>
        <input type="text"
               id="otpInput"
               name="otp"
               maxlength="6"
               class="otp-input"
               inputmode="numeric"
               autocomplete="one-time-code"
               autofocus>

        <input type="hidden" name="otp_verify" value="1">
        <input type="hidden" name="resend_otp" id="resendFlag" value="0">

        <button type="submit" class="primary-btn">
          Verify OTP & Signup
        </button>

        <button type="button"
                id="resendBtn"
                class="resend-btn"
                disabled>
          Resend OTP (02:00)
        </button>
      </div>

    {% else %}
      <!-- NORMAL SIGNUP -->
      <label>Username</label>
      {{ form.username }}

      <label>Email</label>
      {{ form.email }}

      <label>Mobile / Phone</label>
      {{ form.phone }}

      <!-- PASSWORD -->
      <label>Password</label>
      <div class="password-wrap">
        {{ form.password1 }}
        <button type="button" class="toggle-pass">SHOW</button>
      </div>

      <!-- PASSWORD HINTS -->
      <ul class="pass-hints">
        <li id="len">✖ At least 8 characters</li>
        <li id="case">✖ Upper & lowercase letters</li>
        <li id="num">✖ At least one number</li>
        <li id="spec">✖ At least one special character</li>
      </ul>

      <label>Confirm Password</label>
      <div class="password-wrap">
        {{ form.password2 }}
        <button type="button" class="toggle-pass">SHOW</button>
      </div>

      <button type="submit" class="primary-btn">
        Signup (Send OTP)
      </button>
    {% endif %}
  </form>

  <p class="login-link">
    Already have an account? <a href="{% url 'shop:login' %}">Login</a>
  </p>
</div>

<!-- TOAST -->
<div id="otpToast" class="toast">OTP resent successfully</div>

<style>
.signup-card{
  max-width:560px;margin:48px auto;padding:30px;
  background:#fff;border-radius:12px;
  box-shadow:0 10px 30px rgba(3,35,70,0.06)
}
.signup-card input{
  width:100%;height:44px;padding:0 12px;
  border:1px solid #e6edf8;border-radius:8px;font-size:15px
}
.google-btn{
  display:flex;align-items:center;justify-content:center;gap:10px;
  padding:12px;border-radius:10px;border:1px solid #e6edf8;
  font-weight:700;text-decoration:none
}
.google-btn img{width:20px;height:20px;object-fit:contain}
.or-text{text-align:center;color:#6b7280;margin:16px 0}

.password-wrap{
  display:flex;align-items:center;height:44px;
  border:1px solid #e6edf8;border-radius:8px
}
.password-wrap input{border:none;flex:1}
.toggle-pass{
  border:none;background:none;padding:0 12px;
  font-weight:700;color:#2563eb;cursor:pointer
}

.pass-hints{font-size:13px;color:#6b7280;margin:8px 0;padding-left:18px}
.pass-hints li{margin:4px 0}
.pass-hints li.ok{color:#16a34a;font-weight:700}

.readonly-block{
  background:#f8fbff;border:1px solid #e6edf8;
  border-radius:8px;padding:14px;
  font-size:16px;line-height:1.6
}

.otp-box{
  margin-top:16px;padding:16px;
  background:#f8fbff;border:1px solid #e6edf8;border-radius:10px
}
.otp-input{
  height:40px;font-size:16px;
  letter-spacing:3px;text-align:center
}

.primary-btn{
  width:100%;height:46px;margin-top:12px;
  border:none;border-radius:10px;
  background:#0b63d6;color:white;font-weight:700;cursor:pointer
}
.primary-btn:hover{box-shadow:0 8px 20px rgba(11,99,214,.35)}

.resend-btn{
  width:100%;height:44px;margin-top:10px;
  border-radius:10px;border:none;
  background:#cbd5e1;color:#475569;font-weight:700
}
.resend-btn.active{
  background:#e5efff;color:#2563eb;cursor:pointer
}
.resend-btn.active:hover{background:#dbeafe}

.error-box{
  background:#fff1f0;color:#9b1c18;
  padding:10px;border-radius:8px;margin-bottom:12px
}

.toast{
  position:fixed;top:20px;right:-300px;
  background:#16a34a;color:white;
  padding:14px 18px;border-radius:10px;
  font-weight:600;transition:.4s
}
.toast.show{right:20px}
</style>

<script>
/* PASSWORD TOGGLE */
document.querySelectorAll(".toggle-pass").forEach(btn=>{
  btn.onclick=()=>{
    const i=btn.previousElementSibling;
    i.type=i.type==="password"?"text":"password";
    btn.textContent=i.type==="password"?"SHOW":"HIDE";
  }
});

/* PASSWORD STRENGTH */
const pwd=document.querySelector('input[name="{{ form.password1.html_name }}"]');
if(pwd){
  pwd.addEventListener("input",()=>{
    check("len",pwd.value.length>=8);
    check("case",/[a-z]/.test(pwd.value)&&/[A-Z]/.test(pwd.value));
    check("num",/\d/.test(pwd.value));
    check("spec",/[^A-Za-z0-9]/.test(pwd.value));
  });
}
function check(id,ok){
  const el=document.getElementById(id);
  el.classList.toggle("ok",ok);
  el.textContent=(ok?"✔ ":"✖ ")+el.textContent.slice(2);
}

/* OTP SUBMIT – PREVENT JSON PAGE */
const form=document.getElementById("signupForm");
const otpInput=document.getElementById("otpInput");
const otpError=document.getElementById("otpError");

if(otpInput){
  form.addEventListener("submit",e=>{
    e.preventDefault();
    fetch("",{
      method:"POST",
      headers:{ "X-CSRFToken":document.querySelector('[name=csrfmiddlewaretoken]').value },
      body:new FormData(form)
    })
    .then(r=>r.json())
    .then(d=>{
      if(d.success===false){
        otpError.textContent=d.error||"Invalid OTP. Please try again.";
        otpError.style.display="block";
        otpInput.focus();
      }else{
        window.location.href=d.redirect_url||"{% url 'shop:login' %}";
      }
    })
    .catch(()=>{
      otpError.textContent="Something went wrong. Try again.";
      otpError.style.display="block";
    });
  });
}

/* RESEND OTP */
const resendBtn=document.getElementById("resendBtn");
if(resendBtn){
  let t=120;
  const timer=setInterval(()=>{
    t--;
    resendBtn.textContent=`Resend OTP (${String(t/60|0).padStart(2,'0')}:${String(t%60).padStart(2,'0')})`;
    if(t<=0){
      clearInterval(timer);
      resendBtn.disabled=false;
      resendBtn.classList.add("active");
      resendBtn.textContent="Resend OTP";
    }
  },1000);

  resendBtn.onclick=()=>{
    document.getElementById("resendFlag").value="1";
    fetch("",{
      method:"POST",
      headers:{ "X-CSRFToken":document.querySelector('[name=csrfmiddlewaretoken]').value },
      body:new FormData(form)
    });
    document.getElementById("otpToast").classList.add("show");
    setTimeout(()=>document.getElementById("otpToast").classList.remove("show"),3000);
    resendBtn.disabled=true;
    resendBtn.classList.remove("active");
  };
}
</script>
{% endblock %}
