{% extends "shop/base.html" %}
{% load static %}

{% block content %}
<style>
/* (all styles kept / improved for compact qty + layout) */
body { background-color:#f5f5f5; font-family: 'Poppins', Arial, sans-serif; -webkit-font-smoothing:antialiased; }
.product-container { max-width:820px; margin:18px auto 36px; background:linear-gradient(180deg,#fff,#fbfdff); border-radius:14px; box-shadow:0 8px 28px rgba(18,38,63,0.07); padding:22px; display:grid; grid-template-columns:320px 1fr; gap:22px; align-items:start; }
@media (max-width:780px){ .product-container{ grid-template-columns:1fr; padding:18px; } }
.product-image { width:100%; max-width:320px; height:320px; object-fit:cover; border-radius:12px; box-shadow:0 8px 24px rgba(18,38,63,0.06); display:block; background:linear-gradient(180deg,#fff,#f6f9ff); margin:0 auto; }
.product-info { padding:6px 2px; }
.product-name { font-size:1.5rem; font-weight:700; margin:6px 0 8px; color:#0f1724; letter-spacing:-0.2px; }
.product-sub { display:flex; gap:10px; align-items:center; margin-bottom:12px; }
.price-badge { background: linear-gradient(90deg,#ff7a59,#ff5e9e); color:white; padding:8px 14px; border-radius:999px; font-weight:800; font-size:1.05rem; box-shadow:0 6px 18px rgba(255,100,80,0.18); display:inline-flex; align-items:center; gap:8px; }
.product-highlights { display:flex; gap:12px; flex-wrap:wrap; margin-left:auto; }
.chip { background:#f1f7ff; color:#0b4da0; padding:6px 10px; border-radius:999px; font-weight:600; font-size:0.85rem; border:1px solid rgba(11,77,160,0.06); }
.description { text-align:left; color:#42505a; line-height:1.8; font-size:1rem; margin-bottom:14px; padding-right:6px; }
.toggle-btn { color:#0b63d6; cursor:pointer; font-weight:700; font-size:0.94rem; display:inline-block; margin-top:6px; }

.controls { display:flex; gap:12px; align-items:center; margin-top:8px; flex-wrap:wrap; }
.qty-wrap { display:inline-flex; align-items:center; background:#fbfdff; border:1px solid #e6eef6; border-radius:10px; padding:4px; gap:6px; height:44px; min-width:120px; box-shadow:inset 0 1px 0 rgba(255,255,255,0.6); }
.qty-btn { background:transparent; border:none; width:36px; height:36px; border-radius:8px; cursor:pointer; font-size:18px; display:inline-flex; align-items:center; justify-content:center; color:#1f2d3d; }
.qty-btn:hover { background:rgba(0,0,0,0.04); }
.qty-input { width:48px; text-align:center; border:none; background:transparent; font-weight:700; font-size:15px; color:#0f1724; outline:none; }

.btn { padding:10px 16px; border-radius:10px; color:white; text-decoration:none; font-weight:700; display:inline-flex; align-items:center; gap:10px; font-size:0.96rem; height:44px; box-shadow:0 6px 18px rgba(7,22,44,0.06); }
.btn-cart { background:linear-gradient(90deg,#007bff,#00c6ff); }
.btn-buy { background:linear-gradient(90deg,#ff6b6b,#ff8e53); }

.added-flash { margin-left:8px; color:#05683b; font-weight:700; display:inline-block; opacity:0; transform:translateY(-6px); transition:all 220ms ease; }
.added-flash.show { opacity:1; transform:translateY(0); }

@media (max-width:420px){ .price-badge{ font-size:1rem; padding:7px 12px; } .product-container{ padding:14px; gap:12px; } .product-image{ height:240px; } .qty-wrap{ min-width:100px; height:40px; } .btn{ height:40px; font-size:0.9rem; } }
</style>

<div class="product-container">
  <div>
    {% if product.image_url %}
      <img src="{{ product.image_url }}" alt="{{ product.name }}" class="product-image">
    {% else %}
      <img src="https://via.placeholder.com/400x300" alt="No Image" class="product-image">
    {% endif %}
  </div>

  <div class="product-info">
    <h1 class="product-name">{{ product.name }}</h1>

    <div class="product-sub">
      <div class="price-badge">â‚¹ {{ product.price }}</div>
      <div class="product-highlights">
        <div class="chip">100% Wholegrain</div>
        <div class="chip">Ready in 3 min</div>
      </div>
    </div>

    <div class="description" id="desc">
      {% if product.description|length > 400 %}
        <span id="short-desc">{{ product.description|slice:":400" }}...</span>
        <span id="full-desc" style="display:none;">{{ product.description }}</span>
        <div style="margin-top:8px;">
          <span class="toggle-btn" id="toggleDesc">Know More â–¾</span>
        </div>
      {% else %}
        <span>{{ product.description }}</span>
      {% endif %}
    </div>

    <div class="meta-note">ðŸ•’ Fast delivery â€¢ Secure packaging â€¢ Genuine product</div>

    <div class="controls">
      <!-- Add to Cart (AJAX) -->
      <form id="addCartForm" action="{% url 'shop:cart_add' product.id %}" method="post" style="display:flex;align-items:center;gap:10px;">
        {% csrf_token %}
        <div class="qty-wrap" aria-label="Quantity selector">
          <button type="button" class="qty-btn" id="qty-decrease" aria-label="Decrease quantity">âˆ’</button>
          <input type="number" name="qty" id="qty-input" class="qty-input" value="1" min="1" step="1" inputmode="numeric" />
          <button type="button" class="qty-btn" id="qty-increase" aria-label="Increase quantity">+</button>
        </div>

        <button id="addCartBtn" type="button" class="btn btn-cart">ðŸ›’ Add to Cart</button>
        <span id="addedFlash" class="added-flash">âœ… Added</span>
      </form>

      <!-- Buy Now: server adds to cart and redirects to checkout -->
      <form action="{% url 'shop:buy_now' product.id %}" method="post" id="buyNowForm" style="display:inline-block;">
        {% csrf_token %}
        <input type="hidden" name="qty" id="buy-qty" value="1" />
        <button type="submit" class="btn btn-buy">âš¡ Buy Now</button>
      </form>
    </div>
  </div>
</div>

<!-- Related (kept same) -->
{% if related_products %}
  <div class="related-products">
    <h2>You May Also Like</h2>
    <div class="related-scroll" id="relatedScroll">
      {% for p in related_products %}
        <div class="card">
          <a href="{% url 'shop:product_detail' p.slug %}">
            <img src="{{ p.image_url|default:'https://via.placeholder.com/180x140' }}" alt="{{ p.name }}">
            <div style="font-weight:700;">{{ p.name }}</div>
            <div style="color:#ff5e7a;font-weight:700;margin-top:6px;">â‚¹ {{ p.price }}</div>
          </a>
        </div>
      {% endfor %}
    </div>
  </div>
{% endif %}

<script>
/* Helper: get csrftoken from cookie */
function getCookie(name) {
  const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
  return v ? v.pop() : '';
}
const csrftoken = getCookie('csrftoken');

document.addEventListener("DOMContentLoaded", () => {
  const qtyInput = document.getElementById('qty-input');
  const btnDec = document.getElementById('qty-decrease');
  const btnInc = document.getElementById('qty-increase');
  const buyQtyHidden = document.getElementById('buy-qty');
  const addCartBtn = document.getElementById('addCartBtn');
  const addCartForm = document.getElementById('addCartForm');
  const addedFlash = document.getElementById('addedFlash');

  function sanitizeQty() {
    let v = parseInt(qtyInput.value, 10);
    if (isNaN(v) || v < 1) v = 1;
    qtyInput.value = v;
    buyQtyHidden.value = v;
    return v;
  }

  btnDec.addEventListener('click', () => {
    let v = sanitizeQty();
    if (v > 1) {
      qtyInput.value = v - 1;
      buyQtyHidden.value = v - 1;
    }
  });
  btnInc.addEventListener('click', () => {
    let v = sanitizeQty();
    qtyInput.value = v + 1;
    buyQtyHidden.value = v + 1;
  });
  qtyInput.addEventListener('blur', sanitizeQty);
  qtyInput.addEventListener('input', () => {
    const filtered = qtyInput.value.replace(/[^\d]/g, '');
    if (filtered !== qtyInput.value) qtyInput.value = filtered;
    buyQtyHidden.value = qtyInput.value || 1;
  });

  // --- ADD TO CART via AJAX (stay on page) ---
  addCartBtn.addEventListener('click', async (e) => {
    e.preventDefault();
    const url = addCartForm.action;
    const qty = sanitizeQty();

    try {
      addCartBtn.disabled = true;
      addCartBtn.textContent = 'Adding...';

      const resp = await fetch(url, {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': csrftoken,
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: new URLSearchParams({ qty: qty })
      });

      if (!resp.ok) throw new Error('Network error');

      const data = await resp.json();
      if (data && data.success) {
        // show added text + small animation
        addedFlash.classList.add('show');
        setTimeout(() => addedFlash.classList.remove('show'), 1400);

        addCartBtn.textContent = 'Added';
        setTimeout(() => {
          addCartBtn.textContent = 'ðŸ›’ Add to Cart';
          addCartBtn.disabled = false;
        }, 1100);

        // optional: update top cart count if you have an element showing it
        if (data.cart_count !== undefined) {
          const el = document.querySelector('#cartCountBadge');
          if (el) el.textContent = data.cart_count;
        }
      } else {
        throw new Error(data && data.error ? data.error : 'Failed');
      }
    } catch (err) {
      console.error(err);
      addCartBtn.textContent = 'Try again';
      setTimeout(() => { addCartBtn.textContent = 'ðŸ›’ Add to Cart'; addCartBtn.disabled = false; }, 1400);
    }
  });

  // ensure buy form qty hidden kept synced (in case user edits before clicking Buy)
  const buyForm = document.getElementById('buyNowForm');
  if (buyForm) {
    buyForm.addEventListener('submit', () => {
      sanitizeQty();
    });
  }
});
</script>

{% endblock %}
