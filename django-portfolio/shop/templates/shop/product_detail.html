{% extends "shop/base.html" %}
{% load static %}

{% block content %}
<style>
  /* (all existing styles kept / improved for compact qty + layout) */
  body {
    background-color: #f5f5f5;
    font-family: 'Poppins', Arial, sans-serif;
    -webkit-font-smoothing: antialiased;
  }

  .product-container {
    max-width: 820px;
    margin: 18px auto 36px;
    background: linear-gradient(180deg, #fff, #fbfdff);
    border-radius: 14px;
    box-shadow: 0 8px 28px rgba(18, 38, 63, 0.07);
    padding: 22px;
    display: grid;
    grid-template-columns: 320px 1fr;
    gap: 22px;
    align-items: start;
  }

  @media (max-width:780px) {
    .product-container {
      grid-template-columns: 1fr;
      padding: 18px;
    }
  }

  .product-image {
    width: 100%;
    max-width: 320px;
    height: 320px;
    object-fit: cover;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(18, 38, 63, 0.06);
    display: block;
    background: linear-gradient(180deg, #fff, #f6f9ff);
    margin: 0 auto;
  }

  .product-info {
    padding: 6px 2px;
  }

  .product-name {
    font-size: 1.5rem;
    font-weight: 700;
    margin: 6px 0 8px;
    color: #0f1724;
    letter-spacing: -0.2px;
  }

  .product-sub {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-bottom: 12px;
  }

  .price-badge {
    background: linear-gradient(90deg, #ff7a59, #ff5e9e);
    color: white;
    padding: 8px 14px;
    border-radius: 999px;
    font-weight: 800;
    font-size: 1.05rem;
    box-shadow: 0 6px 18px rgba(255, 100, 80, 0.18);
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }

  /* removed product-highlights chips per request */

  .description {
    text-align: left;
    color: #42505a;
    line-height: 1.8;
    font-size: 1rem;
    margin-bottom: 14px;
    padding-right: 6px;
  }

  .toggle-btn {
    color: #0b63d6;
    cursor: pointer;
    font-weight: 700;
    font-size: 0.94rem;
    display: inline-block;
    margin-top: 6px;
  }

  .controls {
    display: flex;
    gap: 12px;
    align-items: center;
    margin-top: 8px;
    flex-wrap: wrap;
  }

  .qty-wrap {
    display: inline-flex;
    align-items: center;
    background: #fbfdff;
    border: 1px solid #e6eef6;
    border-radius: 10px;
    padding: 4px;
    gap: 6px;
    height: 44px;
    min-width: 120px;
    box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6);
  }

  .qty-btn {
    background: transparent;
    border: none;
    width: 36px;
    height: 36px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 18px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    color: #1f2d3d;
  }

  .qty-btn:hover {
    background: rgba(0, 0, 0, 0.04);
  }

  .qty-input {
    width: 48px;
    text-align: center;
    border: none;
    background: transparent;
    font-weight: 700;
    font-size: 15px;
    color: #0f1724;
    outline: none;
  }

  .btn {
    padding: 10px 16px;
    border-radius: 10px;
    color: white;
    text-decoration: none;
    font-weight: 700;
    display: inline-flex;
    align-items: center;
    gap: 10px;
    font-size: 0.96rem;
    height: 44px;
    box-shadow: 0 6px 18px rgba(7, 22, 44, 0.06);
  }

  .btn-cart {
    background: linear-gradient(90deg, #007bff, #00c6ff);
  }

  .btn-buy {
    background: linear-gradient(90deg, #ff6b6b, #ff8e53);
  }

  .added-flash {
    margin-left: 8px;
    color: #05683b;
    font-weight: 700;
    display: inline-block;
    opacity: 0;
    transform: translateY(-6px);
    transition: all 220ms ease;
  }

  .added-flash.show {
    opacity: 1;
    transform: translateY(0);
  }

  /* Feedback styles */
  .feedback-card {
    margin-top: 20px;
    background: #ffffff;
    border-radius: 12px;
    padding: 16px;
    box-shadow: 0 6px 18px rgba(7, 22, 44, 0.04);
  }

  .feedback-title {
    font-weight: 800;
    margin: 0 0 8px 0;
    color: #0f1724;
  }

  .star-row {
    display: flex;
    gap: 6px;
    align-items: center;
    margin: 8px 0 12px 0;
  }

  .star {
    font-size: 28px;
    cursor: pointer;
    user-select: none;
    transition: transform 120ms ease;
  }

  .star:hover {
    transform: scale(1.08);
  }

  .star.empty {
    color: #cfd8e3;
  }

  /* grey */
  .star.filled {
    color: #ffb400;
  }

  /* gold */

  .feedback-text {
    width: 100%;
    min-height: 88px;
    border: 1px solid #e6eef6;
    padding: 10px;
    border-radius: 8px;
    resize: vertical;
    font-size: 14px;
    color: #253147;
    background: #fbfdff;
  }

  .feedback-actions {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-top: 10px;
    flex-wrap: wrap;
  }

  .feedback-btn {
    padding: 9px 12px;
    border-radius: 8px;
    font-weight: 700;
    cursor: pointer;
    border: none;
  }

  .feedback-submit {
    background: linear-gradient(90deg, #06b6d4, #007bff);
    color: #fff;
  }

  .feedback-cancel {
    background: #f1f5f9;
    color: #0f1724;
  }

  .feedback-note {
    color: #6b7280;
    font-size: 13px;
    margin-top: 8px;
  }

  @media (max-width:420px) {
    .price-badge {
      font-size: 1rem;
      padding: 7px 12px;
    }

    .product-container {
      padding: 14px;
      gap: 12px;
    }

    .product-image {
      height: 240px;
    }

    .qty-wrap {
      min-width: 100px;
      height: 40px;
    }

    .btn {
      height: 40px;
      font-size: 0.9rem;
    }

    .star {
      font-size: 24px;
    }
  }
</style>

<div class="product-container">
  <div>
    {% if product.image_url %}
    <img src="{{ product.image_url }}" alt="{{ product.name }}" class="product-image">
    {% else %}
    <img src="https://via.placeholder.com/400x300" alt="No Image" class="product-image">
    {% endif %}
  </div>

  <div class="product-info">
    <h1 class="product-name">{{ product.name }}</h1>

    <div class="product-sub">
      <div class="price-badge">â‚¹ {{ product.price }}</div>
      {# product-highlights removed per request #}
    </div>

    <div class="description" id="desc">
      {% if product.description|length > 400 %}
      <span id="short-desc">{{ product.description|slice:":400" }}...</span>
      <span id="full-desc" style="display:none;">{{ product.description }}</span>
      <div style="margin-top:8px;">
        <span class="toggle-btn" id="toggleDesc">Know More â–¾</span>
      </div>
      {% else %}
      <span>{{ product.description }}</span>
      {% endif %}
    </div>

    <div class="meta-note">ðŸ•’ Fast delivery â€¢ Secure packaging â€¢ Genuine product</div>

    <div class="controls">
      <!-- Add to Cart (AJAX) -->
      <form id="addCartForm" action="{% url 'shop:cart_add' product.id %}" method="post"
        style="display:flex;align-items:center;gap:10px;">
        {% csrf_token %}
        <div class="qty-wrap" aria-label="Quantity selector">
          <button type="button" class="qty-btn" id="qty-decrease" aria-label="Decrease quantity">âˆ’</button>
          <input type="number" name="qty" id="qty-input" class="qty-input" value="1" min="1" step="1"
            inputmode="numeric" />
          <button type="button" class="qty-btn" id="qty-increase" aria-label="Increase quantity">+</button>
        </div>

        <button id="addCartBtn" type="button" class="btn btn-cart">ðŸ›’ Add to Cart</button>
        <span id="addedFlash" class="added-flash">âœ… Added</span>
      </form>

      <!-- Buy Now: server adds to cart and redirects to checkout -->
      <form action="{% url 'shop:buy_now' product.id %}" method="post" id="buyNowForm" style="display:inline-block;">
        {% csrf_token %}
        <input type="hidden" name="qty" id="buy-qty" value="1" />
        <button type="submit" class="btn btn-buy">âš¡ Buy Now</button>
      </form>
    </div>

    <!-- ========== Feedback section ========== -->
    <div class="feedback-card" id="feedbackCard" aria-live="polite">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div>
          <div class="feedback-title">Rate & review this product</div>
          <div class="feedback-note">Tap a star (1â€“5) and leave a short message (optional).</div>
        </div>
        <div id="feedbackStatus" style="font-weight:700;color:#0b63d6;"></div>
      </div>

      <div style="margin-top:10px;">
        <div style="display:flex;gap:10px;align-items:center;">
          <div class="star-row" role="radiogroup" aria-label="Rating">
            <span class="star empty" data-value="1" role="radio" aria-checked="false" tabindex="0">â˜…</span>
            <span class="star empty" data-value="2" role="radio" aria-checked="false" tabindex="0">â˜…</span>
            <span class="star empty" data-value="3" role="radio" aria-checked="false" tabindex="0">â˜…</span>
            <span class="star empty" data-value="4" role="radio" aria-checked="false" tabindex="0">â˜…</span>
            <span class="star empty" data-value="5" role="radio" aria-checked="false" tabindex="0">â˜…</span>
          </div>

          <div style="margin-left:auto;">
            {% comment %} Show computed display_name if provided by view; otherwise show inputs for anonymous users {% endcomment %}
            {% if request.user.is_authenticated %}
              {% if display_name %}
                <div style="font-size:0.95rem;color:#0f1724;font-weight:700;">Signed in as {{ display_name|escape }}</div>
              {% else %}
                <div style="font-size:0.95rem;color:#0f1724;font-weight:700;">Signed in</div>
              {% endif %}
            {% else %}
            <div style="display:flex;gap:8px;">
              <input id="reviewer_name" placeholder="Your name (optional)"
                style="padding:8px;border-radius:8px;border:1px solid #e6eef6;" />
              <input id="reviewer_email" placeholder="Your email (optional)"
                style="padding:8px;border-radius:8px;border:1px solid #e6eef6;" />
            </div>
            {% endif %}
          </div>
        </div>

        <textarea id="feedbackMessage" class="feedback-text" placeholder="Write a short review (optional)">{% if user_feedback %}{{ user_feedback.message }}{% endif %}</textarea>

        <div class="feedback-actions">
          <button id="submitFeedback" class="feedback-btn feedback-submit" type="button">Submit Review</button>
          <button id="clearFeedback" class="feedback-btn feedback-cancel" type="button">Clear</button>
          <div id="feedbackMsg" style="margin-left:auto;color:#0b3b5f;font-weight:700;"></div>
        </div>

        {% if user_feedback and not user_feedback.approved %}
          <div style="margin-top:8px;color:#6b7280;font-size:13px;">Your existing review is pending approval.</div>
        {% endif %}
      </div>
    </div>
    <!-- ========== /Feedback section ========== -->

    <!-- ========== Reviews list (include partial) ========== -->
    <div id="reviewsWrapper" style="margin-top:18px;">
      {% include "shop/reviews_list.html" %}
    </div>
    <!-- ========== /Reviews list ========== -->

    <!-- JSON-LD structured data for product and aggregateRating -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org/",
      "@type": "Product",
      "name": "{{ product.name|escapejs }}",
      "image": "{{ product.image_url|default:'' }}",
      "description": "{{ product.description|truncatechars:200|escapejs }}",
      "sku": "{{ product.slug|escapejs }}",
      "offers": {
        "@type": "Offer",
        "priceCurrency": "INR",
        "price": "{{ product.price }}"
      },
      "aggregateRating": {
        "@type": "AggregateRating",
        "ratingValue": "{{ avg_rating|floatformat:1 }}",
        "reviewCount": "{{ review_count }}"
      }
    }
    </script>


  </div>
</div>

<!-- Related (kept same) -->
{% if related_products %}
<div class="related-products">
  <h2>You May Also Like</h2>
  <div class="related-scroll" id="relatedScroll">
    {% for p in related_products %}
    <div class="card">
      <a href="{% url 'shop:product_detail' p.slug %}">
        <img src="{{ p.image_url|default:'https://via.placeholder.com/180x140' }}" alt="{{ p.name }}">
        <div style="font-weight:700;">{{ p.name }}</div>
        <div style="color:#ff5e7a;font-weight:700;margin-top:6px;">â‚¹ {{ p.price }}</div>
      </a>
    </div>
    {% endfor %}
  </div>
</div>
{% endif %}

<script>
  /* Helper: get csrftoken from cookie */
  function getCookie(name) {
    const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return v ? v.pop() : '';
  }
  const csrftoken = getCookie('csrftoken');

  document.addEventListener("DOMContentLoaded", () => {
    const qtyInput = document.getElementById('qty-input');
    const btnDec = document.getElementById('qty-decrease');
    const btnInc = document.getElementById('qty-increase');
    const buyQtyHidden = document.getElementById('buy-qty');
    const addCartBtn = document.getElementById('addCartBtn');
    const addCartForm = document.getElementById('addCartForm');
    const addedFlash = document.getElementById('addedFlash');

    function sanitizeQty() {
      let v = parseInt(qtyInput.value, 10);
      if (isNaN(v) || v < 1) v = 1;
      qtyInput.value = v;
      buyQtyHidden.value = v;
      return v;
    }

    btnDec.addEventListener('click', () => {
      let v = sanitizeQty();
      if (v > 1) {
        qtyInput.value = v - 1;
        buyQtyHidden.value = v - 1;
      }
    });
    btnInc.addEventListener('click', () => {
      let v = sanitizeQty();
      qtyInput.value = v + 1;
      buyQtyHidden.value = v + 1;
    });
    qtyInput.addEventListener('blur', sanitizeQty);
    qtyInput.addEventListener('input', () => {
      const filtered = qtyInput.value.replace(/[^\d]/g, '');
      if (filtered !== qtyInput.value) qtyInput.value = filtered;
      buyQtyHidden.value = qtyInput.value || 1;
    });

    // --- ADD TO CART via AJAX (stay on page) ---
    addCartBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      const url = addCartForm.action;
      const qty = sanitizeQty();

      try {
        addCartBtn.disabled = true;
        addCartBtn.textContent = 'Adding...';

        const resp = await fetch(url, {
          method: 'POST',
          credentials: 'same-origin',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrftoken,
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: new URLSearchParams({ qty: qty })
        });

        if (!resp.ok) throw new Error('Network error');

        const data = await resp.json();
        if (data && data.success) {
          // show added text + small animation
          addedFlash.classList.add('show');
          setTimeout(() => addedFlash.classList.remove('show'), 1400);

          addCartBtn.textContent = 'Added';
          setTimeout(() => {
            addCartBtn.textContent = 'ðŸ›’ Add to Cart';
            addCartBtn.disabled = false;
          }, 1100);

          // optional: update top cart count if you have an element showing it
          if (data.cart_count !== undefined) {
            const el = document.querySelector('#cartCountBadge');
            if (el) el.textContent = data.cart_count;
          }
        } else {
          throw new Error(data && data.error ? data.error : 'Failed');
        }
      } catch (err) {
        console.error(err);
        addCartBtn.textContent = 'Try again';
        setTimeout(() => { addCartBtn.textContent = 'ðŸ›’ Add to Cart'; addCartBtn.disabled = false; }, 1400);
      }
    });

    // ensure buy form qty hidden kept synced (in case user edits before clicking Buy)
    const buyForm = document.getElementById('buyNowForm');
    if (buyForm) {
      buyForm.addEventListener('submit', () => {
        sanitizeQty();
      });
    }

    // ========= Description toggle (existing) =========
    const toggle = document.getElementById("toggleDesc");
    const shortDesc = document.getElementById("short-desc");
    const fullDesc = document.getElementById("full-desc");
    if (toggle) {
      toggle.addEventListener("click", () => {
        if (fullDesc.style.display === "none") {
          fullDesc.style.display = "inline";
          shortDesc.style.display = "none";
          toggle.textContent = "Show Less";
        } else {
          fullDesc.style.display = "none";
          shortDesc.style.display = "inline";
          toggle.textContent = "Know More â–¾";
        }
      });
    }

    // ========== Feedback UI logic ==========
    const stars = Array.from(document.querySelectorAll('.star'));
    const feedbackMsg = document.getElementById('feedbackMsg');
    const feedbackStatus = document.getElementById('feedbackStatus');
    const feedbackTextarea = document.getElementById('feedbackMessage');
    const submitBtn = document.getElementById('submitFeedback');
    const clearBtn = document.getElementById('clearFeedback');

    let currentRating = 0;

    function updateStarUI(rating) {
      stars.forEach(s => {
        const v = parseInt(s.dataset.value, 10);
        if (v <= rating) {
          s.classList.remove('empty'); s.classList.add('filled'); s.setAttribute('aria-checked', 'true');
        } else {
          s.classList.remove('filled'); s.classList.add('empty'); s.setAttribute('aria-checked', 'false');
        }
      });
    }

    // click and keyboard support for stars
    stars.forEach(s => {
      s.addEventListener('click', () => {
        currentRating = parseInt(s.dataset.value, 10);
        updateStarUI(currentRating);
        feedbackMsg.textContent = '';
      });
      s.addEventListener('keydown', (ev) => {
        if (ev.key === 'Enter' || ev.key === ' ') {
          ev.preventDefault();
          currentRating = parseInt(s.dataset.value, 10);
          updateStarUI(currentRating);
          feedbackMsg.textContent = '';
        }
        // left/right arrows
        if (ev.key === 'ArrowLeft') {
          ev.preventDefault();
          currentRating = Math.max(1, currentRating - 1 || 1);
          updateStarUI(currentRating);
        }
        if (ev.key === 'ArrowRight') {
          ev.preventDefault();
          currentRating = Math.min(5, (currentRating || 0) + 1);
          updateStarUI(currentRating);
        }
      });
    });

    clearBtn.addEventListener('click', () => {
      currentRating = 0;
      updateStarUI(0);
      feedbackTextarea.value = '';
      feedbackMsg.textContent = '';
      feedbackStatus.textContent = '';
      const nameInput = document.getElementById('reviewer_name');
      const emailInput = document.getElementById('reviewer_email');
      if (nameInput) nameInput.value = '';
      if (emailInput) emailInput.value = '';
    });

    submitBtn.addEventListener('click', async () => {
      // simple client-side validation
      if (!currentRating || currentRating < 1) {
        feedbackMsg.textContent = 'Please select a star rating (1â€“5).';
        feedbackMsg.style.color = '#b00020';
        return;
      }
      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';
      feedbackMsg.textContent = '';
      feedbackStatus.textContent = '';

      // build payload; include name/email for anonymous users
      const payload = {
        rating: currentRating,
        message: feedbackTextarea.value || ''
      };

      {% if not request.user.is_authenticated %}
      const reviewerNameEl = document.getElementById('reviewer_name');
      const reviewerEmailEl = document.getElementById('reviewer_email');
      const nameVal = reviewerNameEl ? reviewerNameEl.value.trim() : '';
      const emailVal = reviewerEmailEl ? reviewerEmailEl.value.trim() : '';
      if (nameVal) payload.reviewer_name = nameVal;
      if (emailVal) payload.reviewer_email = emailVal;
      {% endif %}

      try {
        // POST to server: named URL
        const url = "{% url 'shop:product_feedback' product.id %}";
        const resp = await fetch(url, {
          method: 'POST',
          credentials: 'same-origin',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken,
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: JSON.stringify(payload)
        });

        if (!resp.ok) {
          const txt = await resp.text().catch(() => null);
          throw new Error(txt || 'Server error');
        }

        const data = await resp.json().catch(() => ({ success: true }));

        if (data && data.success) {
          feedbackStatus.textContent = data.message || 'Thanks â€” review submitted!';
          feedbackStatus.style.color = data.approved ? '#05683b' : '#0b63d6';

          // If server returned rendered HTML for reviews, replace reviews block (AJAX refresh)
          if (data.html) {
            const wrapper = document.getElementById('reviewsWrapper');
            if (wrapper) {
              wrapper.innerHTML = data.html;
            }
          } else {
            // fallback: reload page to reflect changes
            window.location.reload();
          }

          // update JSON-LD aggregate rating (best-effort)
          try {
            const ld = document.querySelector('script[type="application/ld+json"]');
            if (ld && data.avg_rating !== undefined && data.review_count !== undefined) {
              const obj = JSON.parse(ld.textContent);
              obj.aggregateRating = { "@type": "AggregateRating", "ratingValue": String(parseFloat(data.avg_rating).toFixed(1)), "reviewCount": String(data.review_count) };
              ld.textContent = JSON.stringify(obj);
            }
          } catch (e) { /* ignore */ }

          // clear form fields (even if review pending approval)
          currentRating = 0;
          updateStarUI(0);
          feedbackTextarea.value = '';
          const nameInput = document.getElementById('reviewer_name');
          const emailInput = document.getElementById('reviewer_email');
          if (nameInput) nameInput.value = '';
          if (emailInput) emailInput.value = '';
        } else {
          throw new Error(data && data.error ? data.error : 'Failed to submit');
        }
      } catch (err) {
        console.error('Feedback submit error', err);
        feedbackMsg.textContent = 'Could not submit review. Try again later.';
        feedbackMsg.style.color = '#b00020';
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Review';
      }
    });

  });
</script>

{% endblock %}
