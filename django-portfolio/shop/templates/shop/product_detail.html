{% extends "shop/base.html" %}
{% load static %}

{% block content %}
<style>
  :root {
    --card-bg: #fff;
    --muted: #6b7280;
    --accent: #0b63d6;
    --max-width: 1100px;
  }

  body {
    background-color: #f5f5f5;
    font-family: 'Poppins', Arial, sans-serif;
    -webkit-font-smoothing: antialiased;
  }

  /* container grid: left = image + reviews, right = details + feedback */
  .product-container {
    max-width: var(--max-width);
    margin: 28px auto 40px;
    background: linear-gradient(180deg, #fff, #fbfdff);
    border-radius: 14px;
    box-shadow: 0 8px 28px rgba(18, 38, 63, 0.07);
    padding: 24px;
    display: grid;
    grid-template-columns: 380px 1fr;
    gap: 30px;
    align-items: start;
  }

  @media (max-width:1000px) {
    .product-container {
      grid-template-columns: 320px 1fr;
    }
  }

  @media (max-width:820px) {
    .product-container {
      grid-template-columns: 1fr;
      padding: 18px;
    }
  }

  .left-column { display:flex; flex-direction:column; gap:18px; }
.product-image {
  width: 100%;
  max-width: 380px;
  height: 340px;
  object-fit: contain;              /* âœ… FIX: no crop */
  background: #f8f9fb;              /* neutral background */
  padding: 10px;                    /* breathing space */
  border-radius: 12px;
  box-shadow: 0 8px 24px rgba(18, 38, 63, 0.06);
  display: block;
  margin: 0 auto;
}


  .product-info {
    padding: 6px 2px;
  }

  .product-name {
    font-size: 1.45rem;
    font-weight: 700;
    margin: 6px 0 8px;
    color: #0f1724;
  }

  .product-sub {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
  }

  .price-badge {
    background: linear-gradient(90deg, #ff7a59, #ff5e9e);
    color: white;
    padding: 8px 14px;
    border-radius: 999px;
    font-weight: 800;
    font-size: 1.05rem;
    box-shadow: 0 6px 18px rgba(255, 100, 80, 0.18);
  }

  .description {
    text-align: left;
    color: #42505a;
    line-height: 1.7;
    font-size: 0.98rem;
    margin-bottom: 14px;
  }

  .toggle-btn {
    color: var(--accent);
    cursor: pointer;
    font-weight: 700;
    font-size: 0.94rem;
  }

 .controls {
  display: flex;
  align-items: center;
  gap: 10px;            /* ðŸ”§ tighter spacing */
  margin-top: 10px;
  flex-wrap: wrap;
}

.action-buttons {
  display: flex;
  align-items: center;
  gap: 10px;              /* âœ… tight & clean */
}



  .qty-wrap {
    display: inline-flex;
    align-items: center;
    background: #fbfdff;
    border: 1px solid #e6eef6;
    border-radius: 10px;
    padding: 4px;
    gap: 6px;
    height: 44px;
    min-width: 120px;
  }
  .qty-btn { background: transparent; border: none; width: 36px; height: 36px; border-radius: 8px; cursor: pointer; font-size: 18px; }
  .qty-input { width: 48px; text-align: center; border: none; background: transparent; font-weight: 700; font-size: 15px; }

 .btn {
  height: 46px;
  min-width: 150px;     /* âœ… SAME width */
  padding: 0 18px;
  border-radius: 10px;
  color: #fff;
  font-weight: 700;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  font-size: 0.95rem;
  white-space: nowrap;
}

  /* .btn { padding: 10px 16px; border-radius: 10px; color: white; font-weight: 700; display: inline-flex; align-items:center; gap:10px; font-size:0.96rem; height:44px; } */
  .btn-cart { background: linear-gradient(90deg,#007bff,#00c6ff); }
 /* .btn-buy {
  background: linear-gradient(90deg, #ff7a18, #ff9f1a);
  color: #fff;
  box-shadow: 0 6px 18px rgba(255, 140, 0, 0.25); */
/* } */
.btn-buy {
  background: linear-gradient(90deg, #ff7a18, #ff9f1a);
  box-shadow: 0 4px 14px rgba(255, 140, 0, 0.25);
}

.btn-buy:hover {
  transform: translateY(-1px);
  box-shadow: 0 8px 20px rgba(255, 140, 0, 0.35);
}



  .added-flash { margin-left:8px; color:#05683b; font-weight:700; display:inline-block; opacity:0; transform:translateY(-6px); transition:all 220ms ease; }
  .added-flash.show { opacity:1; transform:translateY(0); }

  /* Feedback card & reviews column */
  .feedback-card { margin-top: 0px; background: var(--card-bg); border-radius: 12px; padding: 16px; box-shadow: 0 6px 18px rgba(7,22,44,0.04); }
  .feedback-title { font-weight:800; margin:0 0 8px 0; color:#0f1724; }
  .feedback-note { color:var(--muted); font-size:13px; }
  .star-row { display:flex; gap:6px; align-items:center; margin:8px 0 12px 0; }
  .star { font-size:26px; cursor:pointer; user-select:none; transition:transform 120ms ease; }
  .star.empty { color:#cfd8e3; }
  .star.filled { color:#ffb400; }

  .feedback-text { width:100%; min-height:88px; border:1px solid #e6eef6; padding:10px; border-radius:8px; resize:vertical; font-size:14px; background:#fbfdff; }

  .feedback-actions { display:flex; gap:10px; align-items:center; margin-top:10px; flex-wrap:wrap; }

  /* improved buttons for feedback */
  .feedback-btn { padding:10px 14px; border-radius:10px; font-weight:800; cursor:pointer; border:none; display:inline-flex; align-items:center; gap:8px; }
  .feedback-submit { background: linear-gradient(90deg,#06b6d4,#007bff); color:#fff; box-shadow: 0 8px 20px rgba(3,102,214,0.12); }
  .feedback-cancel { background: #fff; color: var(--accent); border:1px solid #e6eef6; box-shadow: none; font-weight:700; }

  .reviews-list { margin-top: 10px; }
  .review-item { background:#fff; border-radius:8px; padding:10px; margin-bottom:10px; box-shadow: 0 4px 10px rgba(7,22,44,0.03); }
  .review-meta { display:flex; justify-content:space-between; gap:8px; font-size:0.93rem; color:var(--muted); }
  .review-stars { color:#ffb400; font-weight:700; margin-right:8px; }

  .see-more-wrap { text-align:center; margin-top:8px; }
  .see-more-btn { background:transparent; border:1px dashed #cbd5e1; padding:8px 12px; border-radius:8px; cursor:pointer; color:var(--accent); font-weight:700; }

  /* Related products */
  .related-products { max-width: var(--max-width); margin: 18px auto 60px; padding:0 12px; }
  .related-products h2 { margin:10px 0 12px; font-size:1.05rem; font-weight:700; }
  .related-scroll { display:flex; gap:16px; flex-wrap:wrap; align-items:flex-start; }
  .related-scroll .card { width:180px; background:#fff; border-radius:10px; box-shadow:0 6px 18px rgba(7,22,44,0.04); padding:10px; text-align:center; }
  .related-scroll .card img {
  width: 100%;
  height: 120px;
  object-fit: contain;        /* âœ… no crop */
  background: #f8f9fb;
  padding: 6px;
  border-radius: 6px;
}

.related-scroll .card .product-name {
  font-size: 14px;
  font-weight: 700;
  line-height: 1.3;
  min-height: 36px;           /* âœ… equal height */
  display: -webkit-box;
  -webkit-line-clamp: 2;      /* max 2 lines */
  -webkit-box-orient: vertical;
  overflow: hidden;
}

  .related-scroll .card a { color:inherit; text-decoration:none; display:block; }
  .related-scroll .card .price { color:#ff5e7a; font-weight:700; margin-top:6px; }

  .related-pager { display:flex; gap:12px; align-items:center; justify-content:center; margin-top:14px; }
  .related-pager button { padding:8px 10px; border-radius:8px; border:1px solid #e6eef6; background:#fff; cursor:pointer; }

  @media (max-width:820px) {
    .product-image { height:280px; max-width:320px; }
    .left-column { align-items:center; }
    .related-scroll .card { width:46%; }
  }
  @media (max-width:420px) {
    .product-image { height:200px; }
    .related-scroll .card { width:100%; }
  }
</style>

<div class="product-container" id="productContainer">
  <!-- LEFT: image + reviews -->
  <div class="left-column">
    <div>
      {% if product.image_url %}
        <img src="{{ product.image_url }}" alt="{{ product.name }}" class="product-image">
      {% else %}
        <img src="https://via.placeholder.com/400x300" alt="No Image" class="product-image">
      {% endif %}
    </div>

    <!-- Customer reviews (server returns first page of approved reviews) -->
    <div class="feedback-card" style="padding:12px;">
      <div style="display:flex;align-items:center;gap:10px;justify-content:space-between;">
        <div style="font-weight:800;">Customer reviews</div>
        <div style="color:var(--muted);font-weight:700;">{{ avg_rating|floatformat:1 }} â˜… â€¢ {{ review_count }} reviews</div>
      </div>

      <div id="reviewsWrapper" class="reviews-list" style="margin-top:12px;">
        {% include "shop/reviews_list.html" %}
      </div>

      <div class="see-more-wrap" id="reviewsSeeMoreWrap" aria-live="polite" style="display:block;">
        {% if reviews_paginator and reviews_paginator.num_pages > 1 %}
          <button id="seeMoreReviews" class="see-more-btn" data-current-page="{{ reviews_page.number }}"
            data-total-pages="{{ reviews_paginator.num_pages }}">See more reviews</button>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- RIGHT: product details + "Rate & review" card -->
  <div class="product-info">
    <h1 class="product-name">{{ product.name }}</h1>

    <div class="product-sub">
      <div class="price-badge">â‚¹ {{ product.price }}</div>

      <div style="color:var(--muted); font-size:0.95rem;">
        {% if product.category %}
          {{ product.category.name }}
        {% else %}
          Uncategorized
        {% endif %}
      </div>
    </div>

    <div class="description" id="desc">
      {% if product.description|length > 400 %}
        <span id="short-desc">{{ product.description|slice:":400" }}...</span>
        <span id="full-desc" style="display:none;">{{ product.description }}</span>
        <div style="margin-top:8px;">
          <span class="toggle-btn" id="toggleDesc" role="button" tabindex="0">Know More â–¾</span>
        </div>
      {% else %}
        <span>{{ product.description }}</span>
      {% endif %}
    </div>

    <div style="color:var(--muted); margin-bottom:8px;">ðŸ•’ Fast delivery â€¢ Secure packaging â€¢ Genuine product</div>

 <div class="controls">
  <div class="action-buttons" style="display:flex;gap:10px;flex-wrap:wrap;">

    <!-- ================= ADD TO CART ================= -->
    <form id="addCartForm"
          action="{% url 'shop:cart_add' product.id %}"
          method="post"
          style="display:flex;align-items:center;gap:10px;">
      {% csrf_token %}

      <div class="qty-wrap">
        <button type="button" class="qty-btn" id="qty-decrease">âˆ’</button>
        <input type="number" name="qty" id="qty-input" class="qty-input" value="1" min="1" />
        <button type="button" class="qty-btn" id="qty-increase">+</button>
      </div>

      <button id="addCartBtn" type="button" class="btn btn-cart">
        ðŸ›’ Add to Cart
      </button>

      <span id="addedFlash" class="added-flash">âœ… Added</span>
    </form>

    <!-- ================= BUY NOW (SEPARATE FORM) ================= -->
    <form action="{% url 'shop:buy_now' product.id %}"
          method="post"
          style="display:inline;">
      {% csrf_token %}
      <input type="hidden" name="qty" id="buy-qty" value="1">
      <button type="submit" class="btn btn-buy">
        âš¡ Buy Now
      </button>
    </form>

  </div>
</div>


    <!-- Rate & review this product (right column) -->
    <div class="feedback-card" id="feedbackCard" aria-live="polite" style="margin-top:18px;">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div>
          <div class="feedback-title">Rate & review this product</div>
          <div class="feedback-note">Tap a star (1â€“5) and leave a short message (optional).</div>
        </div>
        <div id="feedbackStatus" style="font-weight:700;color:var(--accent);"></div>
      </div>

      <div style="margin-top:10px;">
        <div style="display:flex;gap:10px;align-items:center;">
          <div class="star-row" role="radiogroup" aria-label="Rating">
            <span class="star empty" data-value="1" role="radio" aria-checked="false" tabindex="0">â˜…</span>
            <span class="star empty" data-value="2" role="radio" aria-checked="false" tabindex="0">â˜…</span>
            <span class="star empty" data-value="3" role="radio" aria-checked="false" tabindex="0">â˜…</span>
            <span class="star empty" data-value="4" role="radio" aria-checked="false" tabindex="0">â˜…</span>
            <span class="star empty" data-value="5" role="radio" aria-checked="false" tabindex="0">â˜…</span>
          </div>

          <div style="margin-left:auto;">
            {% if request.user.is_authenticated %}
              {% if display_name %}
                <div style="font-size:0.95rem;color:#0f1724;font-weight:700;">Signed in as {{ display_name|escape }}</div>
              {% else %}
                <div style="font-size:0.95rem;color:#0f1724;font-weight:700;">Signed in</div>
              {% endif %}
            {% else %}
              <div style="display:flex;gap:8px;">
                <input id="reviewer_name" placeholder="Your name (optional)" style="padding:8px;border-radius:8px;border:1px solid #e6eef6;" />
                <input id="reviewer_email" placeholder="Your email (optional)" style="padding:8px;border-radius:8px;border:1px solid #e6eef6;" />
              </div>
            {% endif %}
          </div>
        </div>

        <textarea id="feedbackMessage" class="feedback-text" placeholder="Write a short review (optional)">{% if user_feedback %}{{ user_feedback.message }}{% endif %}</textarea>

        <div class="feedback-actions">
          <button id="submitFeedback" class="feedback-btn feedback-submit" type="button">{% if user_feedback %}Update Review{% else %}Submit Review{% endif %}</button>
          <button id="clearFeedback" class="feedback-btn feedback-cancel" type="button">Clear</button>
          <div id="feedbackMsg" style="margin-left:auto;color:#0b3b5f;font-weight:700;"></div>
        </div>

        {% if user_feedback and not user_feedback.approved %}
          <div style="margin-top:8px;color:var(--muted);font-size:13px;">Your existing review is pending approval.</div>
        {% endif %}
        {% if user_feedback and user_feedback.approved %}
          <div style="margin-top:8px;color:#238636;font-size:13px;">You already have an approved review â€” you can update it above.</div>
        {% endif %}
      </div>
    </div>

    <!-- JS config holder -->
    <div id="feedbackConfig" data-post-url="{% url 'shop:product_feedback' product.id %}"
      data-user-auth="{{ request.user.is_authenticated|yesno:'1,0' }}"
      data-existing-id="{{ user_feedback.id|default:'' }}"
      data-existing-approved="{{ user_feedback.approved|yesno:'1,0'|default:'0' }}"
      data-existing-rating="{{ user_feedback.rating|default:'' }}" style="display:none;"></div>

  </div>
</div>

<!-- Related products (same page) -->
{% if related_products %}
  <div class="related-products" id="relatedArea">
    <h2>You May Also Like</h2>
    <div class="related-scroll" id="relatedScroll">
      {% for p in related_products %}
        <div class="card" data-slug="{{ p.slug }}">
          <a href="{% url 'shop:product_detail' p.slug %}">
            <img src="{{ p.image_url|default:'https://via.placeholder.com/180x140' }}" alt="{{ p.name }}">
            <div class="product-name" title="{{ p.name }}">
  {{ p.name }}
</div>

            <div class="price">â‚¹ {{ p.price }}</div>
          </a>
        </div>
      {% endfor %}
    </div>

    <div class="related-pager" id="relatedPager" style="display:none;">
      <button id="relPrev" aria-label="Previous related">Prev</button>
      <div id="relPageInfo" style="font-weight:700;color:var(--muted);"></div>
      <button id="relNext" aria-label="Next related">Next</button>
    </div>
  </div>
{% endif %}

<script>
  /* Helper: get csrftoken from cookie */
  function getCookie(name) {
    const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return v ? v.pop() : '';
  }
  function parseHTML(str) {
    const parser = new DOMParser();
    return parser.parseFromString(str,'text/html');
  }

  document.addEventListener("DOMContentLoaded", () => {
    // ============ cart qty controls (same as before) ============
    const qtyInput = document.getElementById('qty-input');
    const btnDec = document.getElementById('qty-decrease');
    const btnInc = document.getElementById('qty-increase');
    const buyQtyHidden = document.getElementById('buy-qty');
    const addCartBtn = document.getElementById('addCartBtn');
    const addCartForm = document.getElementById('addCartForm');
    const addedFlash = document.getElementById('addedFlash');

    function sanitizeQty() {
      if (!qtyInput) return 1;
      let v = parseInt(qtyInput.value,10);
      if (isNaN(v) || v < 1) v = 1;
      qtyInput.value = v;
      if (buyQtyHidden) buyQtyHidden.value = v;
      return v;
    }

    if (btnDec) btnDec.addEventListener('click', ()=>{ let v=sanitizeQty(); if (v>1) { qtyInput.value=v-1; if (buyQtyHidden) buyQtyHidden.value=v-1; } });
    if (btnInc) btnInc.addEventListener('click', ()=>{ let v=sanitizeQty(); qtyInput.value=v+1; if (buyQtyHidden) buyQtyHidden.value=v+1; });
    if (qtyInput) { qtyInput.addEventListener('blur', sanitizeQty); qtyInput.addEventListener('input', ()=>{ const f = qtyInput.value.replace(/[^\d]/g,''); if (f !== qtyInput.value) qtyInput.value = f; if (buyQtyHidden) buyQtyHidden.value = qtyInput.value || 1; }); }

    if (addCartBtn && addCartForm) {
      addCartBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        const url = addCartForm.action;
        const qty = sanitizeQty();
        try {
          addCartBtn.disabled = true;
          addCartBtn.textContent = 'Adding...';
          const resp = await fetch(url, {
            method: 'POST', credentials: 'same-origin',
            headers: {'Content-Type':'application/x-www-form-urlencoded','X-CSRFToken':getCookie('csrftoken'),'X-Requested-With':'XMLHttpRequest'},
            body: new URLSearchParams({ qty: qty })
          });
          if (!resp.ok) throw new Error('Network');
          const data = await resp.json();
          if (data && data.success) {
            if (addedFlash) { addedFlash.classList.add('show'); setTimeout(()=>addedFlash.classList.remove('show'),1400); }
            addCartBtn.textContent = 'Added';
            setTimeout(()=>{ addCartBtn.textContent = 'ðŸ›’ Add to Cart'; addCartBtn.disabled = false; }, 1100);
            if (data.cart_count !== undefined) { const el = document.querySelector('#cartCountBadge'); if (el) el.textContent = data.cart_count; }
          } else { throw new Error(data && data.error ? data.error : 'Failed'); }
        } catch (err) {
          console.error(err);
          addCartBtn.textContent = 'Try again';
          setTimeout(()=>{ addCartBtn.textContent = 'ðŸ›’ Add to Cart'; addCartBtn.disabled = false; }, 1400);
        }
      });
    }

    const buyForm = document.getElementById('buyNowForm'); if (buyForm) buyForm.addEventListener('submit', ()=>sanitizeQty());

    // description toggle
    const toggle = document.getElementById("toggleDesc");
    const shortDesc = document.getElementById("short-desc");
    const fullDesc = document.getElementById("full-desc");
    if (toggle && shortDesc && fullDesc) {
      toggle.addEventListener('click', ()=> {
        if (fullDesc.style.display === "none") { fullDesc.style.display = "inline"; shortDesc.style.display = "none"; toggle.textContent = "Show Less"; }
        else { fullDesc.style.display = "none"; shortDesc.style.display = "inline"; toggle.textContent = "Know More â–¾"; }
      });
      toggle.addEventListener("keydown",(e)=>{ if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggle.click(); } });
    }

    // ========== feedback UI ==========
    const stars = Array.from(document.querySelectorAll('.star'));
    const feedbackMsg = document.getElementById('feedbackMsg');
    const feedbackStatus = document.getElementById('feedbackStatus');
    const feedbackTextarea = document.getElementById('feedbackMessage');
    const submitBtn = document.getElementById('submitFeedback');
    const clearBtn = document.getElementById('clearFeedback');
    const cfgEl = document.getElementById('feedbackConfig');
    const postUrl = cfgEl ? cfgEl.dataset.postUrl : null;
    const existingId = cfgEl ? (cfgEl.dataset.existingId || '') : '';
    const existingRating = cfgEl ? (cfgEl.dataset.existingRating || '') : '';

    let currentRating = 0;
    if (existingRating) { try { currentRating = parseInt(existingRating,10) || 0; } catch(e) { currentRating = 0; } }
    function updateStarUI(r) {
      if (!stars || !stars.length) return;
      stars.forEach(s => {
        const v = parseInt(s.dataset.value,10);
        if (v <= r) { s.classList.remove('empty'); s.classList.add('filled'); s.setAttribute('aria-checked','true'); }
        else { s.classList.remove('filled'); s.classList.add('empty'); s.setAttribute('aria-checked','false'); }
      });
    }
    if (currentRating) updateStarUI(currentRating);

    if (stars && stars.length) {
      stars.forEach(s => {
        s.addEventListener('click', ()=> { currentRating = parseInt(s.dataset.value,10); updateStarUI(currentRating); if (feedbackMsg) feedbackMsg.textContent = ''; });
        s.addEventListener('keydown',(ev)=> {
          if (ev.key === 'Enter' || ev.key === ' ') { ev.preventDefault(); currentRating = parseInt(s.dataset.value,10); updateStarUI(currentRating); if (feedbackMsg) feedbackMsg.textContent = ''; }
          if (ev.key === 'ArrowLeft') { ev.preventDefault(); currentRating = Math.max(1, (currentRating||1)-1); updateStarUI(currentRating); }
          if (ev.key === 'ArrowRight') { ev.preventDefault(); currentRating = Math.min(5, (currentRating||0)+1); updateStarUI(currentRating); }
        });
      });
    }

    if (clearBtn) {
      clearBtn.addEventListener('click', ()=> {
        currentRating = 0; updateStarUI(0); if (feedbackTextarea) feedbackTextarea.value=''; if (feedbackMsg) feedbackMsg.textContent=''; if (feedbackStatus) feedbackStatus.textContent='';
        const ni = document.getElementById('reviewer_name'), ei = document.getElementById('reviewer_email'); if (ni) ni.value=''; if (ei) ei.value='';
      });
    }

    function getAnonReviewer() {
      const nameEl = document.getElementById('reviewer_name'), emailEl = document.getElementById('reviewer_email');
      return { name: nameEl ? nameEl.value.trim() : '', email: emailEl ? emailEl.value.trim() : '' };
    }

    if (submitBtn) {
      submitBtn.addEventListener('click', async (ev) => {
        ev.preventDefault();
        if (!currentRating || currentRating < 1) {
          if (feedbackMsg) { feedbackMsg.textContent = 'Please select a star rating (1â€“5).'; feedbackMsg.style.color = '#b00020'; }
          return;
        }
        if (!postUrl) { if (feedbackMsg) { feedbackMsg.textContent = 'Configuration error (no endpoint).'; feedbackMsg.style.color = '#b00020'; } return; }

        submitBtn.disabled = true;
        const origText = submitBtn.textContent;
        submitBtn.textContent = 'Submitting...';
        if (feedbackMsg) feedbackMsg.textContent = ''; if (feedbackStatus) feedbackStatus.textContent = '';

        const payload = { rating: currentRating, message: (feedbackTextarea ? feedbackTextarea.value.trim() : '') };
        const anon = getAnonReviewer();
        if (anon.name) payload.reviewer_name = anon.name;
        if (anon.email) payload.reviewer_email = anon.email;
        if (existingId) { payload.feedback_id = existingId; payload.update = true; }

        try {
          const resp = await fetch(postUrl, {
            method: 'POST', credentials: 'same-origin',
            headers: { 'Content-Type':'application/json', 'X-CSRFToken': getCookie('csrftoken'), 'X-Requested-With':'XMLHttpRequest' },
            body: JSON.stringify(payload)
          });
          if (!resp.ok) {
            const txt = await resp.text().catch(()=>null);
            throw new Error(txt || 'Server error');
          }
          const data = await resp.json().catch(()=>({success:true}));
          if (data && data.success) {
            if (feedbackStatus) { feedbackStatus.textContent = data.message || (data.approved ? 'Thanks â€” review submitted!' : 'Thanks â€” review submitted (pending approval).'); feedbackStatus.style.color = data.approved ? '#05683b' : '#0b63d6'; }

            // update reviews block if HTML returned
            if (data.html) {
              const wrapper = document.getElementById('reviewsWrapper');
              if (wrapper) wrapper.innerHTML = data.html;
              // reset see-more button to page 1 if available
              const see = document.getElementById('seeMoreReviews');
              if (see) { see.dataset.currentPage = '1'; if (parseInt(see.dataset.totalPages||'1',10) <= 1) see.style.display='none'; else see.style.display='inline-block'; }
            } else {
              window.location.reload();
            }

            // try update JSON-LD (best effort)
            try {
              if (typeof data.avg_rating !== 'undefined' && typeof data.review_count !== 'undefined') {
                const ld = document.querySelector('script[type="application/ld+json"]');
                if (ld) {
                  const obj = JSON.parse(ld.textContent);
                  obj.aggregateRating = { "@type": "AggregateRating", "ratingValue": String(parseFloat(data.avg_rating).toFixed(1)), "reviewCount": String(data.review_count) };
                  ld.textContent = JSON.stringify(obj);
                }
              }
            } catch(e){}

            // clear UI fields
            currentRating = 0; updateStarUI(0); if (feedbackTextarea) feedbackTextarea.value=''; const ni = document.getElementById('reviewer_name'), ei = document.getElementById('reviewer_email'); if (ni) ni.value=''; if (ei) ei.value='';
          } else {
            throw new Error(data && data.error ? data.error : 'Failed to submit');
          }
        } catch (err) {
          console.error('Feedback submit error', err);
          if (feedbackMsg) { feedbackMsg.textContent = 'Could not submit review. Try again later.'; feedbackMsg.style.color = '#b00020'; }
        } finally {
          submitBtn.disabled = false; submitBtn.textContent = origText;
        }
      });
    }

    // ====== Reviews "See more" pagination ======
    const seeMoreBtn = document.getElementById('seeMoreReviews');
    if (seeMoreBtn) {
      seeMoreBtn.addEventListener('click', async () => {
        const cur = parseInt(seeMoreBtn.dataset.currentPage || '1', 10);
        const total = parseInt(seeMoreBtn.dataset.totalPages || '1', 10);
        if (cur >= total) { seeMoreBtn.style.display = 'none'; return; }
        const next = cur + 1;
        seeMoreBtn.disabled = true;
        seeMoreBtn.textContent = 'Loading...';
        try {
          const base = window.location.pathname;
          const resp = await fetch(base + '?rpage=' + next, { credentials: 'same-origin', headers: { 'X-Requested-With': 'XMLHttpRequest' } });
          if (!resp.ok) throw new Error('Network error while loading reviews');
          const text = await resp.text();
          const doc = parseHTML(text);
          const newWrapper = doc.querySelector('#reviewsWrapper');
          if (newWrapper) {
            const wrapper = document.getElementById('reviewsWrapper');
            const incomingItems = Array.from(newWrapper.children);
            if (wrapper && incomingItems.length) incomingItems.forEach(ch => wrapper.appendChild(ch));
            else if (wrapper) wrapper.innerHTML = newWrapper.innerHTML;
          } else {
            const fallback = doc.querySelector('.reviews-list');
            if (fallback && document.getElementById('reviewsWrapper')) document.getElementById('reviewsWrapper').innerHTML = fallback.innerHTML;
          }
          seeMoreBtn.dataset.currentPage = next;
          if (next >= total) seeMoreBtn.style.display = 'none';
          else seeMoreBtn.textContent = 'See more reviews';
        } catch (err) {
          console.error(err);
          seeMoreBtn.textContent = 'Could not load. Try again';
          setTimeout(()=> seeMoreBtn.textContent = 'See more reviews', 1500);
        } finally {
          seeMoreBtn.disabled = false;
        }
      });
    }

    // ====== Related products client-side pager ======
    const relatedScroll = document.getElementById('relatedScroll');
    const relPager = document.getElementById('relatedPager');
    if (relatedScroll) {
      const cards = Array.from(relatedScroll.querySelectorAll('.card'));
      const pageSize = 8; // items per page
      let relPage = 0;
      const totalRelPages = Math.max(1, Math.ceil(cards.length / pageSize));
      const relPrev = document.getElementById('relPrev');
      const relNext = document.getElementById('relNext');
      const relPageInfo = document.getElementById('relPageInfo');

      function showRelPage(n) {
        relPage = Math.max(0, Math.min(totalRelPages - 1, n));
        cards.forEach((c, idx) => { c.style.display = (idx >= relPage*pageSize && idx < (relPage+1)*pageSize) ? 'block' : 'none'; });
        if (relPager) relPager.style.display = (totalRelPages > 1) ? 'flex' : 'none';
        if (relPageInfo) relPageInfo.textContent = (relPage+1) + ' / ' + totalRelPages;
        if (relPrev) relPrev.disabled = (relPage <= 0);
        if (relNext) relNext.disabled = (relPage >= totalRelPages - 1);
      }

      showRelPage(0);
      if (relPrev) relPrev.addEventListener('click', ()=> showRelPage(relPage - 1));
      if (relNext) relNext.addEventListener('click', ()=> showRelPage(relPage + 1));
    }

  }); // end DOMContentLoaded
</script>

{% endblock %}
