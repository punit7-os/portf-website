{% extends "shop/base.html" %}
{% block title %}Your Shopping Cart{% endblock %}

{% block content %}

<div style="max-width:900px; margin:20px auto; background:#fff; padding:25px; border-radius:14px; box-shadow:0 4px 20px rgba(0,0,0,0.08);">

    <h2 style="margin-top:0;">üõí Your Shopping Cart</h2>

    <p><a href="{% url 'shop:product_list' %}" style="text-decoration:none;">‚¨ÖÔ∏è Continue Shopping</a></p>

    {% if items %}
    <table style="width:100%; border-collapse:collapse; margin-top:20px;">
        <tr style="background:#f3f6fa;">
            <th style="padding:12px; text-align:left;">Item</th>
            <th style="padding:12px;">Price</th>
            <th style="padding:12px;">Qty</th>
            <th style="padding:12px;">Total</th>
            <th></th>
        </tr>

        {% for item in items %}
        <tr style="border-bottom:1px solid #eee;" data-id="{{ item.id }}">
            <td style="padding:12px;">{{ item.name }}</td>

            <td style="padding:12px;">‚Çπ {{ item.price }}</td>

            <td style="padding:12px;">
                <button class="qty-btn minus" style="width:28px;height:28px;">‚Äì</button>

                <input type="number" class="qty-input" value="{{ item.quantity }}" min="1"
                    style="width:50px;text-align:center;border:1px solid #ccc;border-radius:6px;">

                <button class="qty-btn plus" style="width:28px;height:28px;">+</button>
            </td>

            <td style="padding:12px; font-weight:600;" class="row-total">‚Çπ {{ item.line_total }}</td>

            <td style="padding:12px;">
                <a href="{% url 'shop:cart_remove' item.id %}" style="color:#ff4b4b; font-weight:600;">‚ùå Remove</a>
            </td>
        </tr>
        {% endfor %}
    </table>

    <h3 style="margin-top:20px;">Total: <strong id="cartTotal">‚Çπ {{ total }}</strong></h3>

    <div style="margin-top:25px;">
        <a href="{% url 'shop:checkout' %}">
            <button style="padding:12px 18px; background:#007BFF; color:#fff; border:none; border-radius:10px; cursor:pointer;">
                Proceed to Checkout
            </button>
        </a>
    </div>

    {% else %}
      <p style="font-size:18px; padding:20px;">Your cart is empty.</p>
    {% endif %}

</div>


<script>
function getCookie(name) {
    const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return v ? v.pop() : '';
}
const csrftoken = getCookie('csrftoken');

// Update header cart badge
function updateCartBadge(count) {
    const badge = document.getElementById("cartCountBadge");
    if (badge) badge.textContent = count;
}

// Update cart via AJAX
async function updateQty(pid, qty, row) {
    const resp = await fetch(`/shop/cart/update/${pid}/`, {
        method: "POST",
        headers: {
            "X-CSRFToken": csrftoken,
            "X-Requested-With": "XMLHttpRequest",
            "Content-Type": "application/x-www-form-urlencoded",
        },
        body: `qty=${qty}`
    });

    const data = await resp.json();

    if (data.success) {
        row.querySelector(".row-total").textContent = "‚Çπ " + data.row_total;
        document.getElementById("cartTotal").textContent = "‚Çπ " + data.cart_total;
        updateCartBadge(data.cart_count);
    }
}

// Quantity buttons
document.querySelectorAll("tr[data-id]").forEach(row => {
    const pid = row.dataset.id;
    const minus = row.querySelector(".minus");
    const plus = row.querySelector(".plus");
    const input = row.querySelector(".qty-input");

    minus.addEventListener("click", () => {
        let q = parseInt(input.value) - 1;
        if (q < 1) q = 1;
        input.value = q;
        updateQty(pid, q, row);
    });

    plus.addEventListener("click", () => {
        let q = parseInt(input.value) + 1;
        input.value = q;
        updateQty(pid, q, row);
    });

    input.addEventListener("change", () => {
        let q = parseInt(input.value);
        if (q < 1) q = 1;
        input.value = q;
        updateQty(pid, q, row);
    });
});
</script>

{% endblock %}
