{% extends "shop/base.html" %}
{% block title %}Your Shopping Cart{% endblock %}

{% block content %}
<div style="max-width:900px; margin:20px auto; background:#fff; padding:25px; border-radius:14px; box-shadow:0 4px 20px rgba(0,0,0,0.08);">

    <h2 style="margin-top:0;">üõí Your Shopping Cart</h2>

    <p><a href="{% url 'shop:product_list' %}" style="text-decoration:none;">‚¨ÖÔ∏è Continue Shopping</a></p>

    {% if items %}
    <table id="cartTable" style="width:100%; border-collapse:collapse; margin-top:20px;">
        <thead>
        <tr style="background:#f3f6fa;">
            <th style="padding:12px; text-align:left;">Item</th>
            <th style="padding:12px;">Price</th>
            <th style="padding:12px;">Qty</th>
            <th style="padding:12px;">Total</th>
            <th></th>
        </tr>
        </thead>
        <tbody>
        {% for item in items %}
        <tr data-product-id="{{ item.id }}" style="border-bottom:1px solid #eee;">
            <td style="padding:12px;">{{ item.name }}</td>
            <td style="padding:12px;">‚Çπ {{ item.price }}</td>
            <td style="padding:12px;">
                <div style="display:flex;gap:6px;align-items:center;">
                  <button class="qty-btn dec" data-action="dec">‚àí</button>
                  <input class="qty-input" type="number" min="0" value="{{ item.quantity }}" style="width:56px;padding:6px;border:1px solid #ddd;border-radius:6px;text-align:center;">
                  <button class="qty-btn inc" data-action="inc">+</button>
                </div>
            </td>
            <td class="row-total" style="padding:12px; font-weight:600;">‚Çπ {{ item.line_total }}</td>
            <td style="padding:12px;">
                <a href="{% url 'shop:cart_remove' item.id %}" style="color:#ff4b4b; font-weight:600;">‚ùå Remove</a>
            </td>
        </tr>
        {% endfor %}
        </tbody>
    </table>

    <h3 id="cartTotal" style="margin-top:20px;">Total: <strong>‚Çπ {{ total }}</strong></h3>

    <div style="margin-top:25px;">
        <a href="{% url 'shop:checkout' %}">
            <button style="padding:12px 18px; background:#007BFF; color:#fff; border:none; border-radius:10px; cursor:pointer;">
                Proceed to Checkout
            </button>
        </a>
    </div>

    {% else %}
      <p style="font-size:18px; padding:20px;">Your cart is empty.</p>
    {% endif %}

</div>

<script>
(function(){
  // helper: get csrf cookie
  function getCookie(name) {
    const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return v ? v.pop() : '';
  }
  const csrftoken = getCookie('csrftoken');

  // update row UI
  function formatINR(n) {
    // simple formatting (no locale dependency)
    return n.toLocaleString('en-IN', { maximumFractionDigits: 2 });
  }

  // update DOM badge
  function setCartBadge(count) {
    const badge = document.getElementById('cartCountBadge');
    if (badge) badge.textContent = count;
  }

  // Bind events
  document.querySelectorAll('#cartTable tbody tr').forEach(row => {
    const productId = row.getAttribute('data-product-id');
    const input = row.querySelector('.qty-input');
    const dec = row.querySelector('.qty-btn.dec');
    const inc = row.querySelector('.qty-btn.inc');

    function updateQty(newQty) {
      // send AJAX to cart_update
      fetch("{% url 'shop:cart_update' 0 %}".replace('/0/', '/' + productId + '/'), {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': csrftoken,
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: new URLSearchParams({ qty: newQty }).toString()
      }).then(async resp => {
        if (!resp.ok) throw new Error('Network error');
        return resp.json();
      }).then(data => {
        if (!data.success) throw new Error('Failed');

        // Update row total
        const rowTotalEl = row.querySelector('.row-total');
        if (rowTotalEl) rowTotalEl.textContent = '‚Çπ ' + formatINR(data.row_total);

        // Update cart total
        const cartTotalEl = document.getElementById('cartTotal');
        if (cartTotalEl) cartTotalEl.innerHTML = 'Total: <strong>‚Çπ ' + formatINR(data.cart_total) + '</strong>';

        // Update header badge using UNIQUE count from server
        if (data.cart_count !== undefined) {
          setCartBadge(data.cart_count);
        } else if (data.total_qty !== undefined) {
          // fallback: if server gave only total_qty, don't change because we want unique count
          // (but this case shouldn't happen with current views)
          setCartBadge(data.total_qty);
        }
      }).catch(err => {
        console.error(err);
        // Revert UI input (optional: re-fetch or reload)
        // For now we won't change input (user may retry)
      });
    }

    // dec button
    if (dec) dec.addEventListener('click', (e) => {
      e.preventDefault();
      let v = parseInt(input.value || '0', 10);
      v = isNaN(v) ? 0 : v;
      v = Math.max(0, v - 1);
      input.value = v;
      updateQty(v);
    });

    // inc button
    if (inc) inc.addEventListener('click', (e) => {
      e.preventDefault();
      let v = parseInt(input.value || '0', 10);
      v = isNaN(v) ? 0 : v;
      v = v + 1;
      input.value = v;
      updateQty(v);
    });

    // manual input change (debounced)
    let timer = null;
    input.addEventListener('input', (e) => {
      clearTimeout(timer);
      timer = setTimeout(() => {
        let v = parseInt(input.value || '0', 10);
        v = isNaN(v) ? 0 : v;
        if (v < 0) v = 0;
        input.value = v;
        updateQty(v);
      }, 450);
    });
  });

})();
</script>
{% endblock %}
